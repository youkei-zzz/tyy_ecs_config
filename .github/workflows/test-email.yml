name: Test email delivery

on:
  workflow_dispatch:
    inputs:
      to_email:
        description: '可选：手动指定收件人'
        required: false
        default: ''
      subject:
        description: '邮件主题'
        required: false
        default: 'CTYun crawler SMTP 测试邮件'
      message:
        description: '邮件正文'
        required: false
        default: '这是一封来自 workflow_dispatch 的测试邮件。'

jobs:
  send-test:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve sender email
        id: sender
        env:
          SMTP_FROM_SECRET: ${{ secrets.SMTP_FROM }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        run: |
          resolved="$SMTP_FROM_SECRET"
          if [ -z "$resolved" ]; then
            resolved="$SMTP_USERNAME"
          fi
          if [ -z "$resolved" ]; then
            echo "No SMTP sender available." >&2
            exit 1
          fi
          echo "EMAIL_FROM=$resolved" >> "$GITHUB_ENV"

      - name: Resolve recipient
        id: recipient
        env:
          INPUT_TO_EMAIL: ${{ inputs.to_email }}
          DEFAULT_TO: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          to="$INPUT_TO_EMAIL"
          if [ -z "$to" ]; then
            to="$DEFAULT_TO"
          fi
          if [ -z "$to" ]; then
            echo "No recipient configured." >&2
            exit 1
          fi
          echo "value=$to" >> "$GITHUB_OUTPUT"

      - name: Resolve SMTP secure mode
        id: smtp_secure
        env:
          SMTP_SECURE_SECRET: ${{ secrets.SMTP_SECURE }}
        run: |
          value="${SMTP_SECURE_SECRET,,}"
          case "$value" in
            ""|"auto"|"default")
              resolved="true"
              ;;
            "true"|"1"|"ssl"|"tls")
              resolved="true"
              ;;
            "false"|"0"|"starttls"|"plain")
              resolved="false"
              ;;
            *)
              resolved="true"
              ;;
          esac
          echo "value=$resolved" >> "$GITHUB_OUTPUT"

      - name: Prepare body file
        env:
          BODY_CONTENT: ${{ inputs.message }}
        run: |
          printf '%s\n' "$BODY_CONTENT" > test-email-body.txt

      - name: Send test email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ inputs.subject }}
          to: ${{ steps.recipient.outputs.value }}
          from: ${{ env.EMAIL_FROM }}
          secure: ${{ steps.smtp_secure.outputs.value == 'true' }}
          body: file://test-email-body.txt
